/**
 * sane, flexible threading for modern browsers
 * @version v0.1.0 - 2015-05-29
 * @author Kevin James <kevinjamesus86@gmail.com>
 * Copyright (c) 2015 Kevin James
 * Licensed under the MIT license.
 */
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.spawn=b()}(this,function(){"use strict";function a(a){this.isMainThread=!0;var e;"string"==typeof a?e=d:"function"==typeof a&&(e=a,a=null),this.file=c.createObjectURL(new Blob([f()+"("+e.toString()+").call(self);"],{type:"text/javascript"})),this.worker=new b(this.file),this._init(),a&&this["import"](a)}var b=window.Worker,c=window.URL||window.webkitURL,d=function(){},e=function(){return"spawn_"+Date.now().toString(32)+Math.random().toString(32)};a.prototype.location=function(){var a=location.href.match(/^(.*\/)?(?:$|(.+?)(?:(\.[^.]*$)|$))/)[1].replace(/\/?$/,"")+"/";return{originPath:a,origin:location.origin}}(),a.prototype.on=function(a,b){if("object"==typeof a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&this.on(c,a[c]);else this.callbacks[a]=this.callbacks[a]||[],this.callbacks[a].push(b);return this},a.prototype.emit=function(a,b,c,d){var f=!1;return"function"==typeof b?(c=b,b=null):"string"==typeof c&&(d=c),d=d||e(),"function"==typeof c&&(this.acks[d]=c,f=!0),this.worker.postMessage({id:d,event:a,data:b,ack:f}),this},a.prototype._invoke=function(a,b,c,d){function e(a){d&&g.emit("spawn_ack",a,c)}var f=this.callbacks[a],g=this;if(f)for(var h=f.length,i=-1;++i<h;)f[i](b,e)},a.prototype.close=function(){return this.isWorker?(this.emit("spawn_close"),this.worker.close()):this.worker.terminate(),this.acks={},this.callbacks={},this.worker.onerror=this.worker.onmessage=null,c.revokeObjectURL(this.file),this},a.prototype["import"]=function(){var a=Array.prototype.slice.call(arguments,0);if(this.isMainThread)this.emit("spawn_import",a);else{for(var b,c=a.length,d=-1;++d<c;)b=a[d],"/"===b.charAt(0)?a[d]=this.location.origin+b:/^https?:/.test(b)||(a[d]=this.location.originPath+b);importScripts.apply(self,a)}return this},a.prototype._init=function(){var a=this;a.acks={},a.callbacks={},a.worker.onmessage=function(b){var c=b.data.data,d=b.data.event,e=b.data.id;switch(d){case"spawn_ack":a.acks[e](c),delete a.acks[e];break;case"spawn_import":a["import"].apply(a,c);break;case"spawn_close":a.close();break;default:a._invoke(d,c,e,b.data.ack)}},a.isMainThread&&(a.worker.onerror=function(b){a._invoke("error",b)})};var f=function(){function b(a){return"function"==typeof a?a.toString():JSON.stringify(a)}var c=Object.keys(a.prototype).reduce(function(c,d){return c+"Spawn.prototype."+d+"="+b(a.prototype[d])+";"},"");return function(){return["self.spawn = (function() {","function uuid() {","return 'worker_' + Date.now().toString(32) + Math.random().toString(32);","}","function Spawn() {","this.isWorker = true;","this.worker = self;","this._init();","}",c,"return new Spawn;","})();"].join("\n")}}();return function(b){return new a(b)}});