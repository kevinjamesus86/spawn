/**
 * spawn! event-driven web workers for modern browsers
 * @version v1.0.0 - 2015-06-03
 * @author Kevin James <kevinjamesus86@gmail.com>
 * Copyright (c) 2015 Kevin James
 * Licensed under the MIT license.
 * https://github.com/kevinjamesus86/spawn
 */
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.Spawn=b()}(this,function(){"use strict";function a(c,d){if(!(this instanceof a))return new a(c,d);d=e({},a.config,d);var f,g="";"string"==typeof c?f=c:"function"==typeof c&&(g=h(c)),this.isMainThread=!0,this.file=i('importScripts("'+k+'");\nspawn.exportAs("'+d.workerAs+'");\n'+g),this.worker=new b(this.file),this._init(),f&&this.importScripts(f)}var b=window.Worker,c=window.URL||window.webkitURL,d=Object.prototype.hasOwnProperty,e=function(a){var b=Array.prototype.slice.call(arguments,1);return b.forEach(function(b){if(b)for(var c in b)d.call(b,c)&&(a[c]=b[c])}),a},f=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,g=/^function\s*[^{]*\{([\s\S]*)\}$/m,h=function(a){return a.toString().replace(f,"").replace(g,"$1")},i=function(a){return c.createObjectURL(new Blob([a],{type:"application/javascript"}))},j={workerAs:"spawn"};a.fn=a.prototype,a.config=e(j),a.fn.uuid=function(){var a=this.isMainThread?"spawn_":"worker_";return a+Date.now().toString(32)+Math.random().toString(32)},a.fn.location={origin:location.origin||location.protocol+"//"+location.host,originPath:location.href.match(/^(.*\/)?(?:$|(.+?)(?:(\.[^.]*$)|$))/)[1].replace(/\/?$/,"")+"/"},a.fn.on=function(a,b){return this.callbacks[a]=this.callbacks[a]||[],this.callbacks[a].push(b),this},a.fn.emit=function(a,b,c,d){var e=!1;return"function"==typeof b?(c=b,b=null):"string"==typeof c&&(d=c),d=d||this.uuid(),"function"==typeof c&&(this.acks[d]=c,e=!0),this.worker.postMessage({id:d,event:a,data:b,ack:e}),this},a.fn._invoke=function(a,b,c,d){function e(a){d&&g.emit("spawn_ack",a,c)}var f=this.callbacks[a],g=this;if(f)for(var h=f.length,i=-1;++i<h;)f[i].call(g,b,e)},a.fn.close=function(){return this.isWorker?(this.emit("spawn_close"),this.worker.close()):(this.closed=!0,this.worker.terminate(),c.revokeObjectURL(this.file),this.on=this.emit=this.close=this.importScripts=function(){return this},this.worker.removeEventListener("message",this._messageHandler,!1),this.worker.removeEventListener("error",this._errorHandler,!1),this.acks=this.callbacks=this.file=this.worker=null),this},a.fn.importScripts=function(){var a=Array.prototype.slice.call(arguments,0);if(this.isMainThread)this.emit("spawn_import",a);else{for(var b,c=a.length,d=-1;++d<c;)b=a[d],"/"===b.charAt(0)?a[d]=this.location.origin+b:/^(blob|https?)(:|%3a)/i.test(b)||(a[d]=this.location.originPath+b);importScripts.apply(self,a)}return this},a.fn._init=function(){var a=this;a.acks={},a.callbacks={},a._messageHandler=a._messageHandler.bind(a),a.worker.addEventListener("message",a._messageHandler,!1),a.isMainThread&&(a._errorHandler=a._errorHandler.bind(a),a.worker.addEventListener("error",a._errorHandler,!1))},a.fn._messageHandler=function(a){var b,c=this,d=a.data.data,e=a.data.event,f=a.data.id;switch(e){case"spawn_ack":b=c.acks[f],delete c.acks[f],b.call(c,d);break;case"spawn_import":c.importScripts.apply(c,d);break;case"spawn_close":c.close();break;default:c._invoke(e,d,f,a.data.ack)}},a.fn._errorHandler=function(a){this._invoke("error",a)};var k=function(){var b=Object.keys(a.fn).reduce(function(b,c){var d=a.fn[c];return d="function"==typeof d?d.toString():JSON.stringify(d),b+"Spawn.fn."+c+"="+d+";"},"");return i("self.spawn = (function() {function Spawn() {this.isWorker = true;this.worker = self;this._init();}Spawn.fn=Spawn.prototype;"+b+"var instance;var prevExport;Spawn.fn.exportAs = function(name) {self[name] = instance;if (prevExport) {delete self[prevExport];}prevExport = name;};return (instance = new Spawn);})();")}();return a});